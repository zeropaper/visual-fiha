# P5.js Layer Implementation Plan

This document outlines the implementation plan for adding P5.js layer support to Visual Fiha, based on the existing Canvas2D and ThreeJS layer implementations.

## Overview

P5.js is a popular creative coding library that provides a simple and intuitive API for drawing and animation. Adding P5.js layer support will allow users to leverage the familiar P5.js API while benefiting from Visual Fiha's messaging architecture, input system, and real-time capabilities.

## Architecture Analysis

### Current Layer Implementation Pattern

Based on the existing Canvas2D and ThreeJS layers, the following pattern emerges:

1. **Base Layer Extension**: All layers extend the `Layer` class from `src/layers/Layer.ts`
2. **Type Definition**: Each layer has a unique `type` string identifier
3. **API Injection**: Layer-specific APIs are merged into the `api` object in the constructor
4. **Canvas Management**: Layers work with HTML5 Canvas or OffscreenCanvas
5. **Scriptable Integration**: Layers inherit setup/animation script execution from `Scriptable`

### Key Files to Modify/Create

1. **New Files to Create**:
   - `src/layers/P5JS/P5JSLayer.ts` - Main layer implementation
   - `src/layers/P5JS/p5Tools.ts` - P5.js-specific tools and utilities
   - `src/layers/P5JS/p5Tools.editor-types.txt` - TypeScript definitions for Monaco Editor
   - `src/layers/P5JS/P5JSLayer.test.dom.ts` - Unit tests

2. **Files to Modify**:
   - `src/types.ts` - Add "p5js" to LayerConfig type union
   - `src/display/Display.worker.ts` - Add P5JSLayer import and case handling
   - `src/display/types.ts` - Update DisplayState layers type to include P5JSLayer
   - `src/controls/features/ScriptEditor/ScriptEditor.extraLibs.ts` - Add P5.js type definitions
   - `package.json` - Add P5.js dependency

## Implementation Plan

### Phase 1: Core Layer Structure

#### 1.1 Create P5JSLayer Class

```typescript
// src/layers/P5JS/P5JSLayer.ts
import p5 from 'p5';
import * as mathTools from "../../utils/mathTools";
import miscTools from "../../utils/miscTools";
import Layer, { type LayerOptions } from "../Layer";
import p5Tools from "./p5Tools";

export interface P5JSLayerOptions extends LayerOptions {}

export default class P5JSLayer extends Layer {
  readonly type = "p5js";

  constructor(options: P5JSLayerOptions) {
    super(options);
    
    // Initialize P5.js instance in instance mode
    this.#p5Instance = new p5(this.#sketch, this.canvas);
    
    this.api = {
      ...mathTools,
      ...miscTools,
      ...p5Tools(this.#p5Instance),
      ...super.api,
      p5: this.#p5Instance,
    };
  }

  #p5Instance: p5;
  #isSetupComplete = false;

  // P5.js sketch function
  #sketch = (p: p5) => {
    p.setup = () => {
      // P5.js setup is handled by our setup script
      this.#isSetupComplete = true;
    };

    p.draw = () => {
      // P5.js draw loop is controlled by our animation script
      // This will be called by execAnimation
    };
  };

  get p5() {
    return this.#p5Instance;
  }

  // Override width/height setters to update P5.js
  set width(width: number) {
    super.width = width;
    if (this.#p5Instance && this.#isSetupComplete) {
      this.#p5Instance.resizeCanvas(width, this.height);
    }
  }

  set height(height: number) {
    super.height = height;
    if (this.#p5Instance && this.#isSetupComplete) {
      this.#p5Instance.resizeCanvas(this.width, height);
    }
  }
}
```

#### 1.2 Create P5.js Tools Module

```typescript
// src/layers/P5JS/p5Tools.ts
import type p5 from 'p5';

export default function p5Tools(p5Instance: p5) {
  return {
    // Convenience functions that wrap P5.js methods
    background: (color: string | number) => p5Instance.background(color),
    fill: (color: string | number) => p5Instance.fill(color),
    noFill: () => p5Instance.noFill(),
    stroke: (color: string | number) => p5Instance.stroke(color),
    noStroke: () => p5Instance.noStroke(),
    strokeWeight: (weight: number) => p5Instance.strokeWeight(weight),
    
    // Drawing functions
    circle: (x: number, y: number, diameter: number) => p5Instance.circle(x, y, diameter),
    ellipse: (x: number, y: number, w: number, h?: number) => p5Instance.ellipse(x, y, w, h),
    rect: (x: number, y: number, w: number, h: number) => p5Instance.rect(x, y, w, h),
    line: (x1: number, y1: number, x2: number, y2: number) => p5Instance.line(x1, y1, x2, y2),
    point: (x: number, y: number) => p5Instance.point(x, y),
    
    // Transformation functions
    translate: (x: number, y: number) => p5Instance.translate(x, y),
    rotate: (angle: number) => p5Instance.rotate(angle),
    scale: (s: number | number[]) => Array.isArray(s) ? p5Instance.scale(s[0], s[1]) : p5Instance.scale(s),
    push: () => p5Instance.push(),
    pop: () => p5Instance.pop(),
    
    // Utility functions
    map: (value: number, start1: number, stop1: number, start2: number, stop2: number) => 
      p5Instance.map(value, start1, stop1, start2, stop2),
    lerp: (start: number, stop: number, amt: number) => p5Instance.lerp(start, stop, amt),
    constrain: (n: number, low: number, high: number) => p5Instance.constrain(n, low, high),
    
    // Dimension helpers
    width: () => p5Instance.width,
    height: () => p5Instance.height,
    
    // Clear function
    clear: () => p5Instance.clear(),
  };
}
```

### Phase 2: Type System Integration

#### 2.1 Update Core Types

```typescript
// src/types.ts - Add to LayerConfig union type
export type LayerConfig = Prettify<
  (
    | {
        type: "canvas";
      }
    | {
        type: "threejs";
      }
    | {
        type: "p5js";
      }
  ) &
    LayerConfigBase
>;
```

#### 2.2 Update Display Worker

```typescript
// src/display/Display.worker.ts - Add import and case
import P5JSLayer from "../layers/P5JS/P5JSLayer";

// Update type annotation
let layer: Canvas2DLayer | ThreeJSLayer | P5JSLayer | null = null;

// Add case in switch statement
switch (options.type) {
  case "canvas":
    layer = new Canvas2DLayer(completeOptions);
    break;
  case "threejs":
    layer = new ThreeJSLayer(completeOptions);
    break;
  case "p5js":
    layer = new P5JSLayer(completeOptions);
    break;
  default:
    console.warn(`[display worker] Layer type is not supported`, options);
    break;
}
```

#### 2.3 Update Display Types

```typescript
// src/display/types.ts
import type P5JSLayer from "../layers/P5JS/P5JSLayer";

export interface DisplayState extends Omit<RuntimeData, "layers"> {
  id: string;
  readonly control: boolean;
  layers: Array<Canvas2DLayer | ThreeJSLayer | P5JSLayer>;
}
```

### Phase 3: Editor Integration

#### 3.1 Create TypeScript Definitions

```typescript
// src/layers/P5JS/p5Tools.editor-types.txt
declare const background: (color: string | number) => void;
declare const fill: (color: string | number) => void;
declare const noFill: () => void;
declare const stroke: (color: string | number) => void;
declare const noStroke: () => void;
declare const strokeWeight: (weight: number) => void;

declare const circle: (x: number, y: number, diameter: number) => void;
declare const ellipse: (x: number, y: number, w: number, h?: number) => void;
declare const rect: (x: number, y: number, w: number, h: number) => void;
declare const line: (x1: number, y1: number, x2: number, y2: number) => void;
declare const point: (x: number, y: number) => void;

declare const translate: (x: number, y: number) => void;
declare const rotate: (angle: number) => void;
declare const scale: (s: number | number[]) => void;
declare const push: () => void;
declare const pop: () => void;

declare const map: (value: number, start1: number, stop1: number, start2: number, stop2: number) => number;
declare const lerp: (start: number, stop: number, amt: number) => number;
declare const constrain: (n: number, low: number, high: number) => number;

declare const width: () => number;
declare const height: () => number;
declare const clear: () => void;

declare const p5: import('p5');
```

#### 3.2 Update Script Editor

```typescript
// src/controls/features/ScriptEditor/ScriptEditor.extraLibs.ts
import p5Types from "@layers/P5JS/p5Tools.editor-types.txt?raw";

export const extraLibs: Record<
  LayerConfig["type"],
  Record<"setup" | "animation", [string, string][]>
> = {
  canvas: {
    setup: [[canvasTypes, "ts:canvas.d.ts"]],
    animation: [[canvasTypes, "ts:canvas.d.ts"]],
  },
  threejs: {
    setup: [
      [threeTypes, "ts:three.d.ts"],
      [threeBundleTypes, "file://node_modules/@types/three/index.d.ts"],
    ],
    animation: [
      [threeTypes, "ts:three.d.ts"],
      [threeBundleTypes, "file://node_modules/@types/three/index.d.ts"],
    ],
  },
  p5js: {
    setup: [
      [p5Types, "ts:p5.d.ts"],
      ["declare module 'p5';", "file://node_modules/@types/p5/index.d.ts"],
    ],
    animation: [
      [p5Types, "ts:p5.d.ts"],
      ["declare module 'p5';", "file://node_modules/@types/p5/index.d.ts"],
    ],
  },
};
```

### Phase 4: Testing

#### 4.1 Unit Tests

```typescript
// src/layers/P5JS/P5JSLayer.test.dom.ts
import { describe, it, expect, vi } from "vitest";
import P5JSLayer from "./P5JSLayer";
import type { P5JSLayerOptions } from "./P5JSLayer";

const setupScript = 'background(0); cache.initialized = true;';

let layer: P5JSLayer;

const options: P5JSLayerOptions = {
  id: "p5LayerId",
  canvas: document.createElement("canvas"),
};

describe("P5JSLayer instantiation", () => {
  it("creates a P5.js layer with proper type", () => {
    layer = new P5JSLayer(options);
    expect(layer).toBeTruthy();
    expect(layer.type).toBe("p5js");
    expect(layer.id).toBe(options.id);
  });

  it("has P5.js instance available", () => {
    expect(layer.p5).toBeTruthy();
    expect(layer.api.p5).toBeTruthy();
  });

  it("has P5.js tools in API", () => {
    expect(layer.api.background).toBeTypeOf("function");
    expect(layer.api.circle).toBeTypeOf("function");
    expect(layer.api.rect).toBeTypeOf("function");
  });
});

describe("P5JSLayer scripts", () => {
  it("can execute setup script", async () => {
    layer.setup.code = setupScript;
    const result = await layer.execSetup();
    expect(layer.cache.initialized).toBe(true);
  });
});
```

### Phase 5: Dependencies

#### 5.1 Package Dependencies

```json
// package.json additions
{
  "dependencies": {
    "p5": "^1.7.0"
  },
  "devDependencies": {
    "@types/p5": "^1.7.0"
  }
}
```

## Integration Considerations

### Performance Considerations

1. **Instance Mode**: Use P5.js in instance mode to avoid global namespace pollution
2. **Canvas Reuse**: Leverage the existing canvas element from the Layer base class
3. **Memory Management**: Properly dispose of P5.js instances when layers are removed

### Visual Fiha Messaging Integration

1. **Input Data**: P5.js scripts will have access to the `read()` function for MIDI, audio, and time data
2. **Real-time Updates**: Animation scripts will be called every frame by the display worker
3. **Error Handling**: Compilation and execution errors will be handled by the existing Scriptable system

### User Experience

1. **Familiar API**: P5.js users can use familiar functions like `background()`, `circle()`, `rect()`
2. **TypeScript Support**: Monaco Editor will provide autocompletion and type checking
3. **Documentation**: Create API documentation similar to canvas-api.md and threejs-api.md

## Implementation Checklist

- [ ] **Phase 1**: Core layer structure
  - [ ] Create P5JSLayer class
  - [ ] Create p5Tools module
  - [ ] Implement basic P5.js integration

- [ ] **Phase 2**: Type system integration
  - [ ] Update LayerConfig types
  - [ ] Update Display.worker.ts
  - [ ] Update display types

- [ ] **Phase 3**: Editor integration
  - [ ] Create TypeScript definitions
  - [ ] Update ScriptEditor extraLibs
  - [ ] Test Monaco Editor integration

- [ ] **Phase 4**: Testing
  - [ ] Write unit tests
  - [ ] Test layer creation/destruction
  - [ ] Test script execution

- [ ] **Phase 5**: Documentation and polish
  - [ ] Create p5js-api.md documentation
  - [ ] Add demo scripts
  - [ ] Update main documentation

## Example Usage

Once implemented, users will be able to create P5.js layers with scripts like:

**Setup Script:**
```javascript
// Initialize with black background
background(0);
cache.angle = 0;
```

**Animation Script:**
```javascript
// Read MIDI data for interaction
const midiNote = read('midi.note.60', 0);
const time = read('time.elapsed', 0);

// Clear and draw animated circle
background(0, 20); // Slight trail effect
fill(255, midiNote * 255, 100);
circle(width() / 2, height() / 2, 50 + midiNote * 100);

// Rotate based on time
push();
translate(width() / 2, height() / 2);
rotate(time * 0.001);
stroke(255);
line(-50, 0, 50, 0);
pop();
```

This implementation plan provides a comprehensive roadmap for adding P5.js support to Visual Fiha while maintaining consistency with the existing architecture and patterns.
